<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APD Portal - Create Announcement</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav>
        <div class="nav-container">
            <div class="nav-links">
                <a href="/"><img src="apdlogo.png" alt="APD Logo" class="nav-logo"></a>
                <a href="/">HOME</a>
                <a href="/coc.html">COC</a>
                <div class="dropdown">
                    <a href="#">DIVISIONS</a>
                    <div class="dropdown-content">
                        <a href="/divisions/field-training.html">Field Training</a>
                        <a href="/divisions/gang-narcotics.html">Gang & Narcotics</a>
                        <a href="/divisions/detectives.html">Detectives Bureau</a>
                        <a href="/divisions/community.html">Community Outreach</a>
                    </div>
                </div>
                <a href="/roster.html" class="restricted-nav">ROSTER</a>
                <a href="/sop.html" class="restricted-nav">SOP</a>
                <a href="/group.html" class="restricted-nav">GROUP</a>
                <a href="/shift-log.html" class="restricted-nav">SHIFT LOG</a>
                <a href="/wanted.html">WANTED</a>
                <a href="/create-update.html" class="restricted-create">CREATE UPDATE</a>
                <a href="/updates.html">UPDATES</a>
            </div>
            <div class="nav-icons">
                <button onclick="handleDiscordAuth()" class="login-btn">
                    <i class="fab fa-discord"></i>
                    LOGIN WITH DISCORD
                </button>
            </div>
        </div>
    </nav>

    <div class="create-update-container">
        <!-- Creator Profile Preview -->
        <div class="create-profile">
            <img src="" alt="Your Avatar" class="create-avatar" />
            <span class="create-username"></span>
        </div>
        <h2>Create Announcement</h2>
        <form id="update-form">
            <label for="title">Title</label>
            <input type="text" id="title" name="title" required>

            <label for="date">Date</label>
            <input type="date" id="date" name="date" required>

            <label for="image">Image URL (optional)</label>
            <input type="text" id="image" name="image" placeholder="Optional: image URL">

            <label for="description">Description</label>
            <textarea id="description" name="description" rows="5" required></textarea>

            <button type="submit">Publish</button>
            <input type="hidden" id="creatorAvatar" name="creatorAvatar">
            <input type="hidden" id="creatorUsername" name="creatorUsername">
        </form>
        <div id="form-msg" style="margin-top:1rem;color:var(--accent);"></div>
    </div>

    <script src="script.js"></script>
    <script>
    // Populate creator info from session storage
    const authData = JSON.parse(sessionStorage.getItem('discord_auth') || '{}');
    const userData = authData.user || {};
    
    // Populate hidden fields and profile preview
    document.getElementById('creatorAvatar').value = userData.avatar || '';
    document.getElementById('creatorUsername').value = userData.username || '';
    
    if (userData.username) {
        const avatarEl = document.querySelector('.create-avatar');
        const usernameEl = document.querySelector('.create-username');
        avatarEl.src = userData.avatar || 'https://cdn.discordapp.com/embed/avatars/0.png';
        usernameEl.textContent = userData.username;
    }

    document.getElementById('update-form').addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = {
            title: formData.get('title'),
            date: formData.get('date'),
            image: formData.get('image'),
            description: formData.get('description'),
            creator: {
                username: userData.username,
                avatar: userData.avatar
            },
            timestamp: new Date().toISOString()
        };

        try {
            const res = await fetch('/.netlify/functions/updates', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `${authData.tokenType} ${authData.token}`
                },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                document.getElementById('form-msg').textContent = 'Update created successfully!';
                document.getElementById('form-msg').style.color = 'var(--accent)';
                e.target.reset();
                
                // Redirect to updates page after 2 seconds
                setTimeout(() => {
                    window.location.href = '/updates.html';
                }, 2000);
            } else {
                const error = await res.json();
                document.getElementById('form-msg').textContent = error.message || 'Failed to create update.';
                document.getElementById('form-msg').style.color = '#ff3b3b';
            }
        } catch (err) {
            console.error('Error creating update:', err);
            document.getElementById('form-msg').textContent = 'Network error. Please try again.';
            document.getElementById('form-msg').style.color = '#ff3b3b';
        }
    });
    </script>
</body>
</html> 